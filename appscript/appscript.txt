function doGet(e) {

  if (!e) {
    return ContentService.createTextOutput(
      "doGet was run manually. No URL parameters received."
    );
  }

  const action = e.parameter.action;

  return ContentService.createTextOutput("Invalid Request");
}

function sendWeeklyPdfReport() {

  const email = "syam.sg@innovaturelabs.com";

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Activities");
  const data = sheet.getDataRange().getValues();

  const today = new Date();
  const lastWeek = new Date();
  lastWeek.setDate(today.getDate() - 7);

  let filteredRows = [];
  filteredRows.push(data[0]);

  for (let i = 1; i < data.length; i++) {
    const rowDate = new Date(data[i][5]);

    if (rowDate >= lastWeek && rowDate <= today) {
      filteredRows.push(data[i]);
    }
  }

  if (filteredRows.length === 1) {
    Logger.log("âŒ No weekly data found.");
    return;
  }

  let html = `
    <h2 style="color:darkblue;">Weekly Activity Report</h2>
    <p><b>From:</b> ${lastWeek.toDateString()}  
       <b>To:</b> ${today.toDateString()}</p>

    <table border="1" cellpadding="5" cellspacing="0"
           style="border-collapse:collapse; font-size:12px;">
  `;

  filteredRows.forEach(row => {
    html += "<tr>";
    row.forEach(cell => {
      html += `<td>${cell}</td>`;
    });
    html += "</tr>";
  });

  html += "</table>";

  const pdfBlob = Utilities.newBlob(html, "text/html")
    .getAs("application/pdf")
    .setName("Weekly_Activity_Report.pdf");

  MailApp.sendEmail({
    to: email,
    subject: "ðŸ“Œ Weekly Team Activity Report",
    htmlBody: `
      Hi Syam,<br><br>
      Please find attached the weekly activity report.<br><br>
      Regards,<br>
      Activity Logging System
    `,
    attachments: [pdfBlob]
  });

  Logger.log("âœ… Weekly report email sent successfully!");
}

function createWeeklyTrigger() {

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === "sendWeeklyPdfReport") {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  ScriptApp.newTrigger("sendWeeklyPdfReport")
    .timeBased()
    .everyWeeks(1)
    .onWeekDay(ScriptApp.WeekDay.MONDAY)
    .atHour(9)
    .create();

  Logger.log("âœ… Weekly trigger created successfully!");
}

function sendMonthlyPdfReport() {

  const email = "syam.sg@innovaturelabs.com";

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Activities");
  const data = sheet.getDataRange().getValues();

  const today = new Date();

  const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

  let filteredRows = [];
  filteredRows.push(data[0]);

  for (let i = 1; i < data.length; i++) {
    const rowDate = new Date(data[i][5]);

    if (rowDate >= firstDay && rowDate <= today) {
      filteredRows.push(data[i]);
    }
  }

  if (filteredRows.length === 1) {
    Logger.log("No monthly data found.");
    return;
  }

  let html = "<h2>ðŸ“… Monthly Activity Report</h2>";
  html += `<p>From: ${firstDay.toDateString()} To: ${today.toDateString()}</p>`;
  html += "<table border='1' cellpadding='5' cellspacing='0'>";

  filteredRows.forEach(row => {
    html += "<tr>";
    row.forEach(cell => {
      html += `<td>${cell}</td>`;
    });
    html += "</tr>";
  });

  html += "</table>";

  const tempFile = DriveApp.createFile(
    "Monthly_Report.html",
    html,
    MimeType.HTML
  );

  const pdfBlob = tempFile.getAs("application/pdf")
    .setName("Monthly_Activity_Report.pdf");

  tempFile.setTrashed(true);

  MailApp.sendEmail({
    to: email,
    subject: "ðŸ“… Monthly Team Activity Report",
    htmlBody: `
      Hi Syam,<br><br>
      Please find attached the monthly activity report.<br><br>
      Regards,<br>
      Activity Logging System
    `,
    attachments: [pdfBlob]
  });

  Logger.log("âœ… Monthly PDF Report Sent Successfully!");
}

function createMonthlyTrigger() {

  ScriptApp.newTrigger("sendMonthlyPdfReport")
    .timeBased()
    .onMonthDay(1)
    .atHour(9)
    .create();

  Logger.log("âœ… Monthly trigger created successfully!");
}

function checkMembersActivity() {
  const ADMIN_EMAIL = "syam.sg@innovaturelabs.com";

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const membersSheet = ss.getSheetByName("Members");
  const activitySheet = ss.getSheetByName("Activities");

  const membersData = membersSheet.getDataRange().getValues();
  const activityData = activitySheet.getDataRange().getValues();

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const activeToday = new Set();

  for (let i = 1; i < activityData.length; i++) {
    let activityDate = new Date(activityData[i][5]);
    activityDate.setHours(0, 0, 0, 0);


    if (activityDate.getTime() === today.getTime()) {
      activeToday.add(activityData[i][1]);
    }
  }

  let inactiveMembers = [];


  for (let i = 1; i < membersData.length; i++) {

    const memberId = membersData[i][0];
    const memberName = membersData[i][1];

    if (!activeToday.has(memberId.toString().trim())) {
      inactiveMembers.push(memberName);
    }
  }

  if (inactiveMembers.length > 0) {
    const formattedList = inactiveMembers.map(name => "â€¢ " + name).join("\n");

    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: "Inactive Members Report - " + new Date().toDateString(),
      body:
        "Hello Admin,\n\n" +
        "The following members have not logged activity today:\n\n" +
        formattedList +
        "\n\nTotal Inactive Members: " + inactiveMembers.length +
        "\n\nRegards,\nActivity Monitoring System"
    });
  }
}

function sendPendingActivitiesReport() {

  const ADMIN_EMAIL = "syam.sg@innovaturelabs.com";

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const membersSheet = ss.getSheetByName("Members");
  const activitySheet = ss.getSheetByName("Activities");

  const membersData = membersSheet.getDataRange().getValues();
  const activityData = activitySheet.getDataRange().getValues();

  const todayString = Utilities.formatDate(
    new Date(),
    Session.getScriptTimeZone(),
    "yyyy-MM-dd"
  );

  const memberMap = new Map();
  for (let i = 1; i < membersData.length; i++) {
    const id = membersData[i][0];
    const name = membersData[i][1];
    memberMap.set(id.toString().trim(), name);
  }

  let pendingList = [];

  for (let i = 1; i < activityData.length; i++) {

    const activityName = activityData[i][3];
    const memberId = activityData[i][1];
    const activityDate = activityData[i][5];
    const status = activityData[i][7];
    const description = activityData[i][4];

    if (!activityDate || !memberId || !status) continue;

    const activityDateString = Utilities.formatDate(
      new Date(activityDate),
      Session.getScriptTimeZone(),
      "yyyy-MM-dd"
    );

    if (
      activityDateString === todayString &&
      status.toString().trim().toLowerCase() === "pending"
    ) {

      const memberName = memberMap.get(memberId.toString().trim()) || "Unknown";

      pendingList.push({
        memberName,
        activityName,
        description,
        status
      });
    }
  }

  if (pendingList.length > 0) {

    let message = "Hello Admin,\n\n";
    message += "Pending Activities Report (" + todayString + ")\n\n";

    pendingList.forEach(item => {
      message +=
        "Member: " + item.memberName + "\n" +
        "Activity: " + item.activityName + "\n" +
        "Description: " + item.description + "\n" +
        "Status: " + item.status + "\n\n";
    });

    message += "Total Pending Activities: " + pendingList.length;

    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: "Pending Activities Report - " + todayString,
      body: message
    });
  }
}